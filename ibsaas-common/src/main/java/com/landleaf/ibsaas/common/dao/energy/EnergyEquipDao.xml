<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC
        "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.landleaf.ibsaas.common.dao.energy.EnergyEquipDao">

    <resultMap id="energyEquipVOResultMap" type="com.landleaf.ibsaas.common.domain.energy.vo.EnergyEquipVO">
        <id column="id" property="id"/>
        <result column="equip_no" property="equipNo"/>
        <result column="equip_name" property="equipName"/>
        <result column="equip_type" property="equipType"/>
        <result column="equip_floor" property="equipFloor"/>
        <result column="equip_area" property="equipArea"/>
        <result column="equip_classification" property="equipClassification"/>
        <result column="comment" property="comment"/>
        <result column="verify_time" property="verifyTime"/>
        <result column="verify_value" property="verifyValue"/>
        <collection property="nodes" ofType="com.landleaf.ibsaas.common.domain.hvac.vo.HvacNodeVO">
            <result column="nodeId" property="nodeId"/>
            <result column="node_name" property="nodeName"/>
            <result column="floor" property="floor"/>
        </collection>
    </resultMap>



    <resultMap id="equipWithNodes" type="com.landleaf.ibsaas.common.domain.energy.vo.EnergyEquipVO">
        <id column="id" property="id"/>
        <collection property="nodes" ofType="com.landleaf.ibsaas.common.domain.hvac.vo.HvacNodeVO">
            <result column="node_id" property="nodeId"/>
        </collection>
    </resultMap>



    <sql id="energyEquipVOSql">
        tee.id,
        tee.equip_no,
        tee.equip_name,
        tee.equip_type,
        tee.equip_floor,
        tee.equip_area,
        tee.equip_classification,
        tee.comment,
        teev.verify_time,
        teev.verify_value,
        thn.id AS nodeId,
        thn.node_name,
        thn.floor
    </sql>

    <sql id="equipWithNodesSql">
        tee.id,
        teen.node_id
    </sql>

    <select id="count" resultType="java.lang.Integer">
        SELECT COUNT(1) FROM t_energy_equip
    </select>
    <select id="selectUnique" resultType="com.landleaf.ibsaas.common.domain.energy.EnergyEquip">
        SELECT id FROM t_energy_equip
        WHERE equip_no=#{equipNo}
        OR equip_name=#{equipName}
    </select>
    <select id="getEnergyEquipVO" resultMap="energyEquipVOResultMap">
        SELECT
        <include refid="energyEquipVOSql"/>
        FROM t_energy_equip tee
        LEFT JOIN t_energy_equip_verify teev ON tee.id=teev.equip_id AND teev.is_active=1 AND teev.enable_flag=1
        LEFT JOIN t_energy_equip_node teen ON tee.id=teen.equip_id AND teen.is_active=1
        LEFT JOIN t_hvac_node thn ON teen.node_id=thn.id AND thn.is_active=1
        WHERE tee.is_active=1
        AND tee.id=#{id}
    </select>
    <select id="getEnergyEquipSearchVO"
            resultType="com.landleaf.ibsaas.common.domain.energy.vo.EnergyEquipSearchVO">
        SELECT
        tee.id,
        tee.equip_name,
        tee.equip_no,
        tee.equip_type,
        tcs_1.setting_value AS equipTypeStr,
        tee.equip_floor,
        tcs_2.setting_value AS equipFloorStr,
        tee.equip_area,
        tcs_3.setting_value AS equipAreaStr,
        tee.equip_classification,
        tcs_4.setting_value AS equipClassificationStr,
        teev.verify_time,
        teev.verify_value
        FROM t_energy_equip tee
        LEFT JOIN t_energy_equip_verify teev ON tee.id=teev.equip_id AND teev.is_active=1 AND teev.enable_flag=1
        LEFT JOIN t_config_setting tcs_1 ON tee.equip_type=tcs_1.setting_code AND tcs_1.setting_type='equip_type' AND tcs_1.is_active=1
        LEFT JOIN t_config_setting tcs_2 ON tee.equip_floor=tcs_2.setting_code AND tcs_2.setting_type='equip_floor' AND tcs_2.is_active=1
        LEFT JOIN t_config_setting tcs_3 ON tee.equip_area=tcs_3.setting_code AND tcs_3.setting_type='equip_area' AND tcs_3.is_active=1
        LEFT JOIN t_config_setting tcs_4 ON tee.equip_classification=tcs_4.setting_code AND tcs_4.setting_type='equip_classification' AND tcs_4.is_active=1
        WHERE tee.is_active=1
        <if test="equipName!=null and equipName!=''">
            AND LOCATE(#{equipName},tee.equip_name)
        </if>
        <if test="equipType!=null and equipType!=''">
            AND tcs_1.setting_code=#{equipType}
        </if>
        <if test="equipFloor!=null and equipFloor!=''">
            AND tcs_2.setting_code=#{equipFloor}
        </if>
        <if test="equipArea!=null and equipArea!=''">
            AND tcs_3.setting_code=#{equipArea}
        </if>
        <if test="equipClassification!=null and equipClassification!=''">
            AND tcs_4.setting_code=#{equipClassification}
        </if>
    </select>
    <select id="allWithNodeIds" resultMap="equipWithNodes">
        SELECT
        <include refid="equipWithNodesSql"/>
        FROM t_energy_equip tee
        LEFT JOIN t_energy_equip_node teen ON tee.id=teen.equip_id AND teen.is_active=1
        WHERE tee.is_active=1
    </select>
</mapper>
