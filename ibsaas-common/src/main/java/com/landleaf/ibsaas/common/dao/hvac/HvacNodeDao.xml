<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC
        "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.landleaf.ibsaas.common.dao.hvac.HvacNodeDao">

    <resultMap id="hvacNodeVOResultMap" type="com.landleaf.ibsaas.common.domain.hvac.vo.HvacNodeVO">
        <id column="id" property="id"/>
        <result column="device_id" property="deviceId"/>
        <result column="node_name" property="nodeName"/>
        <result column="floor" property="floor"/>
        <collection property="hvacFieldVOList" ofType="com.landleaf.ibsaas.common.domain.hvac.vo.HvacFieldVO">
            <result column="field_name" property="fieldName"/>
            <result column="field_description" property="fieldDescription"/>
            <result column="permission" property="permission"/>
            <result column="bacnet_object_type" property="bacnetObjectType"/>
            <result column="instance_number" property="instanceNumber"/>
        </collection>
    </resultMap>

    <sql id="hvacNodeVOSql">
        thn.id,
        thn.device_id,
        thn.node_name,
        thn.floor,
        thf.field_name,
        thf.field_description,
        thf.permission,
        thp.bacnet_object_type,
        thp.instance_number
    </sql>

    <select id="getHvacNodeByDeviceId" resultMap="hvacNodeVOResultMap">
        SELECT
        <include refid="hvacNodeVOSql"/>
        FROM
        t_hvac_node thn
        LEFT JOIN t_hvac_point thp ON thn.id=thp.node_id AND thp.is_active=1
        LEFT JOIN t_hvac_field thf ON thp.field_id = thf.id AND thn.device_id=thf.device_id AND thf.is_active=1
        WHERE thn.is_active=1
        AND thn.device_id=#{deviceId}
    </select>
    <select id="getHvacNodeByNodeId" resultMap="hvacNodeVOResultMap">
        SELECT
        <include refid="hvacNodeVOSql"/>
        FROM
        t_hvac_node thn
        LEFT JOIN t_hvac_point thp ON thn.id=thp.node_id AND thp.is_active=1
        LEFT JOIN t_hvac_field thf ON thp.field_id = thf.id AND thn.device_id=thf.device_id AND thf.is_active=1
        WHERE thn.is_active=1
        AND thn.id=#{id}
    </select>
    <select id="getHvacNodeFieldVO" resultType="com.landleaf.ibsaas.common.domain.hvac.vo.HvacNodeFieldVO">
        SELECT
        thp.node_id AS nodeId, thf.field_name AS fieldName,	thd.device_instance_number AS deviceInstanceNumber,
        thp.bacnet_object_type AS bacnetObjectType, thp.instance_number AS instanceNumber, thf.permission
        FROM t_hvac_point thp
        INNER JOIN t_hvac_field thf ON  thp.field_id = thf.id AND thf.is_active=1
        INNER JOIN t_hvac_device thd ON thf.device_id = thd.id AND thd.is_active=1
        WHERE thp.is_active=1
        <if test="nodeId!=null and nodeId!=''">
            AND thp.node_id=#{nodeId}
        </if>
        <if test="fieldName!=null and fieldName!=''">
            AND thf.field_name=#{fieldName}
        </if>
    </select>
    <select id="getHvacNodeFieldVOByFieldName"
            resultType="com.landleaf.ibsaas.common.domain.hvac.vo.HvacNodeFieldVO">
        SELECT
        thp.node_id AS nodeId, thf.field_name AS fieldName,	thd.device_instance_number AS deviceInstanceNumber,
        thp.bacnet_object_type AS bacnetObjectType, thp.instance_number AS instanceNumber, thf.permission
        FROM t_hvac_point thp
        INNER JOIN t_hvac_field thf ON  thp.field_id = thf.id AND thf.is_active=1
        INNER JOIN t_hvac_device thd ON thf.device_id = thd.id AND thd.is_active=1
        WHERE thp.is_active=1
        <if test="fieldName!=null and fieldName!=''">
            AND thf.field_name=#{fieldName}
        </if>
    </select>
</mapper>
